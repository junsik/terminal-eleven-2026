# MATCH_ENGINE.md — 하이라이트 기반 경기 엔진 상세

## 1. 목표
- 90분 전체를 분 단위로 상세 시뮬레이션하지 않고,
- PC가 관여하는 **핵심 장면(하이라이트)**만 생성/플레이하여
- 모바일에서도 빠르고 반복 가능한 축구 커리어 경험을 제공한다.

## 2. 엔진 입력/출력
### 입력(Input)
- PC stats/status (피로/자신감/부상 등)
- Opponent difficulty (공격/수비 레이팅)
- Match context (홈/원정, 스코어, 분, 중요도)
- Command (사용자 선택)

### 출력(Output)
- 결과(Result): 성공/실패/파울/카드/득점 등
- 변경(ChangeSet): 평점Δ, 피로Δ, 자신감Δ, 부상확률/발생, 스코어Δ
- 로그(LogLines): 상황 설명 + 결과 설명(1~3줄)

## 3. 하이라이트 생성(GenerateHighlights)
경기 시작 시, 약 12개의 하이라이트를 생성한다. 분포 예시:
- 0~15분: 2개
- 16~45분: 3개
- 46~75분: 4개
- 76~90+분: 3개(상황/스코어에 따라 압축)

하이라이트 생성은 다음 값에 영향을 받는다:
- 신뢰(trust)가 낮으면 관여도↓ (하이라이트 수가 8~10으로 감소 가능)
- 상대 수비 레이팅이 높으면 득점형 이벤트 비율↓, 경합/압박 이벤트 비율↑
- 스코어가 뒤지면 공격형 이벤트 가중치↑ (마지막 15분)

## 4. 확률 모델(정석, 튜닝 가능)
### 4.1 기본 공식
```text
p = clamp( Base
          + Σ( stat_i * weight_i ) / 100
          + contextModifier
          - fatiguePenalty
          + confidenceBonus
          + randomJitter, 0, 1 )
```
- Base: 이벤트별 기본 성공 확률(예: 0.35)
- stat_i/weight_i: 이벤트별 관련 스탯과 가중치
- contextModifier: 압박/거리/각도/수적 우세 등
- fatiguePenalty: 피로가 60 이상부터 비선형 증가 권장
- confidenceBonus: 자신감(+1~+3) 시 소폭 상향

### 4.2 피로 페널티(권장)
- fatigue 0~60: 0
- 61~80: (fatigue-60) * 0.003
- 81~100: 0.06 + (fatigue-80) * 0.006

## 5. 평점/신뢰 업데이트
### 5.1 평점 누적(RatingAccumulator)
- 긍정:
  - 골 +8.0
  - 어시스트 +5.0
  - 유효슈팅 +3.0
  - 키패스 +3.0
  - 압박 성공 +2.0
- 부정:
  - 결정적 찬스 실패 -4.0
  - 소유권 상실 -2.0
  - 경고 -3.0
  - 퇴장 -8.0

최종 평점은 다음으로 정규화:
```text
final = clamp(6.0 + (sum / 10.0), 0.0, 10.0)
```
(초기 평균 6점대, 활약 시 7~9점대로 상승)

### 5.2 신뢰(Trust)
- trustΔ = (finalRating - 6.0) * 4 + 행동 가산(훈련 성실/무리 감점)
- 상한/하한: 0..100
- 신뢰가 일정 이상이면 선발 확률↑, 하이라이트 관여도↑

## 6. 부상/카드
- 이벤트별 injuryRiskBase 정의(예: 태클 경합 0.03)
- 부상 확률 = base * (1 + fatigue/100) * (상대 압박 가중)
- 부상 종류는 경미/중간/심각으로 구간 분리
- 카드는 파울 이벤트에서 별도 확률(심판 성향 파라미터 추후)

## 7. 텍스트 생성 규칙
- 템플릿 기반: `descriptionKey + params`
- 문장 길이: 1~2문장
- 동일 템플릿 반복 방지: 최근 10개 템플릿 중복 제한

## 8. 자동 플레이 봇(밸런스 검증)
- 기본 정책: SAFE_PLAY 우선, 찬스에서 SHOOT 증가
- 1000경기 시뮬레이션으로 득점/평점 분포 산출
